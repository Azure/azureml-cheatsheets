(self.webpackChunkaml_cheatsheet=self.webpackChunkaml_cheatsheet||[]).push([[250],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return s},kt:function(){return m}});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},s=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),u=c(t),m=a,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return t?r.createElement(h,o(o({ref:n},s),{},{components:t})):r.createElement(h,o({ref:n},s))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=u;var p={};for(var l in n)hasOwnProperty.call(n,l)&&(p[l]=n[l]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var c=2;c<i;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},997:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return o},metadata:function(){return p},toc:function(){return l},default:function(){return s}});var r=t(4034),a=t(9973),i=(t(7294),t(3905)),o={title:"\u5206\u6563 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0",id:"distributed-training",description:"Guide to distributed training in Azure ML.",keywords:["distributed training","mpi","process group","pytorch","horovod","tensorflow"]},p={unversionedId:"cheatsheets/python/v1/distributed-training",id:"cheatsheets/python/v1/distributed-training",isDocsHomePage:!1,title:"\u5206\u6563 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0",description:"Guide to distributed training in Azure ML.",source:"@site/i18n/ja/docusaurus-plugin-content-docs/current/cheatsheets/python/v1/distributed-training.md",sourceDirName:"cheatsheets/python/v1",slug:"/cheatsheets/python/v1/distributed-training",permalink:"/azureml-cheatsheets/ja/docs/cheatsheets/python/v1/distributed-training",editUrl:"https://github.com/Azure/azureml-cheatsheets/tree/main/website/docs/cheatsheets/python/v1/distributed-training.md",version:"current",frontMatter:{title:"\u5206\u6563 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0",id:"distributed-training",description:"Guide to distributed training in Azure ML.",keywords:["distributed training","mpi","process group","pytorch","horovod","tensorflow"]},sidebar:"pythonSidebar",previous:{title:"\u30e1\u30c8\u30ea\u30c3\u30af",permalink:"/azureml-cheatsheets/ja/docs/cheatsheets/python/v1/logging"},next:{title:"Azure ML \u30b3\u30f3\u30c6\u30ca\u30fc",permalink:"/azureml-cheatsheets/ja/docs/cheatsheets/python/v1/docker-build"}},l=[{value:"\u57fa\u672c\u7684\u306a\u30b3\u30f3\u30bb\u30d7\u30c8",id:"\u57fa\u672c\u7684\u306a\u30b3\u30f3\u30bb\u30d7\u30c8",children:[]},{value:"MPI (Message Passing Interface)",id:"mpi-message-passing-interface",children:[{value:"Horovod",id:"horovod",children:[]},{value:"DeepSpeed",id:"deepspeed",children:[]},{value:"Open MPI \u306e\u74b0\u5883\u5909\u6570",id:"open-mpi-\u306e\u74b0\u5883\u5909\u6570",children:[]}]},{value:"PyTorch",id:"pytorch",children:[{value:"\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u521d\u671f\u5316",id:"\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u521d\u671f\u5316",children:[]},{value:"\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3",id:"\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3",children:[]},{value:"DistributedDataParallel (per-process-launch)",id:"distributeddataparallel-per-process-launch",children:[]},{value:"<code>torch.distributed.launch</code> (per-node-launch) \u306e\u4f7f\u7528",id:"torchdistributedlaunch-per-node-launch-\u306e\u4f7f\u7528",children:[]},{value:"PyTorch Lightning",id:"pytorch-lightning",children:[]},{value:"Hugging Face Transformers",id:"hugging-face-transformers",children:[]}]},{value:"TensorFlow",id:"tensorflow",children:[{value:"TF_CONFIG",id:"tf_config",children:[]}]},{value:"InfiniBand \u306b\u3088\u308b GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30b7\u30e7\u30f3",id:"infiniband-\u306b\u3088\u308b-gpu-\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30b7\u30e7\u30f3",children:[]}],c={toc:l};function s(e){var n=e.components,t=(0,a.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"\u57fa\u672c\u7684\u306a\u30b3\u30f3\u30bb\u30d7\u30c8"},"\u57fa\u672c\u7684\u306a\u30b3\u30f3\u30bb\u30d7\u30c8"),(0,i.kt)("p",null,"\u3053\u306e\u30ac\u30a4\u30c9\u306e\u8aad\u8005\u306f ",(0,i.kt)("em",{parentName:"p"},"data parallelism\u3001distributed data parallelism\u3001model parallelism")," \u306a\u3069\u306e\u5206\u6563 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306b\u5bfe\u3059\u308b\u57fa\u672c\u7684\u306a\u30b3\u30f3\u30bb\u30d7\u30c8\u3092\u7406\u89e3\u3057\u3066\u3044\u308b\u3068\u60f3\u5b9a\u3057\u3066\u3044\u307e\u3059\u3002"),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u3069\u306e parallelism \u3092\u4f7f\u3046\u3079\u304d\u304b\u5224\u65ad\u3067\u304d\u306a\u3044\u5834\u5408: 90% \u4ee5\u4e0a\u306e\u5834\u5408\u3067 ",(0,i.kt)("strong",{parentName:"p"},"Distributed Data Parallelism")," \u304c\u4f7f\u308f\u308c\u307e\u3059\u3002"))),(0,i.kt)("h2",{id:"mpi-message-passing-interface"},"MPI (Message Passing Interface)"),(0,i.kt)("p",null,"Azure ML \u306f\u5404\u30ce\u30fc\u30c9\u3067\u4e0e\u3048\u3089\u308c\u305f\u30d7\u30ed\u30bb\u30c3\u30b5\u30fc\u6570\u306e MPI \u30b8\u30e7\u30d6\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002\u5229\u7528\u8005\u306f\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"process_count_per_node"),"\u304c 1 \u306b\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5834\u5408 (\u30c7\u30d5\u30a9\u30eb\u30c8) \u306f per-node-launcher\u3001\u30c7\u30d0\u30a4\u30b9/ GPU \u306e\u6570\u306b\u7b49\u3057\u3044\u5834\u5408\u306f per-process-launcher \u3092\u4f7f\u3063\u3066\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002Azure ML \u306f\u88cf\u5074\u3067\u5b8c\u5168\u306a MPI \u5b9f\u884c\u30b3\u30de\u30f3\u30c9 (",(0,i.kt)("inlineCode",{parentName:"p"},"mpirun"),") \u3092\u69cb\u7bc9\u3057\u3066\u51e6\u7406\u3057\u307e\u3059\u3002"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Azure ML \u306f\u4eca\u306e\u3068\u3053\u308d\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u306e\u5b8c\u5168\u306a",(0,i.kt)("inlineCode",{parentName:"p"},"mpirun"),"\u306e\u3088\u3046\u306a head-node-launcher \u30b3\u30de\u30f3\u30c9\u3084 DeepSpeed \u30e9\u30f3\u30c1\u30e3\u30fc\u3092\u53d7\u3051\u53d6\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3002\u3053\u306e\u6a5f\u80fd\u306f\u5c06\u6765\u306e\u30ea\u30ea\u30fc\u30b9\u3067\u8ffd\u52a0\u3055\u308c\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002"))),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Azure ML \u306e MPI \u30b8\u30e7\u30d6\u3092\u4f7f\u3046\u305f\u3081\u306b\u3001\u30d9\u30fc\u30b9\u3068\u306a\u308b Docker \u30a4\u30e1\u30fc\u30b8\u306b\u306f MPI \u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002",(0,i.kt)("a",{parentName:"p",href:"https://www.open-mpi.org/"},"Open MPI")," \u306f\u3059\u3079\u3066\u306e ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Azure/AzureML-Containers"},"AzureML GPU \u30d9\u30fc\u30b9\u30a4\u30e1\u30fc\u30b8"),"\u306b\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\u3082\u3057\u3082\u30ab\u30b9\u30bf\u30e0 Docker \u30a4\u30e1\u30fc\u30b8\u3092\u4f7f\u3046\u5834\u5408\u306b\u306f\u30e6\u30fc\u30b6\u30fc\u304c\u8cac\u4efb\u3092\u6301\u3063\u3066 MPI \u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002Open MPI \u304c\u63a8\u5968\u3067\u3059\u304c\u3001Intel MPI \u306a\u3069\u306e\u4ed6\u306e MPI \u5b9f\u88c5\u3092\u4f7f\u3046\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002Azure ML \u306f\u3053\u306e\u4ed6\u306b\u3082",(0,i.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/machine-learning/resource-curated-environments"},"\u4eba\u6c17\u306e\u3042\u308b\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u306e\u30ad\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3055\u308c\u305f\u74b0\u5883"),"\u3082\u63d0\u4f9b\u3057\u307e\u3059\u3002"))),(0,i.kt)("p",null,"MPI\u3092\u4f7f\u3063\u3066\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u306b\u306f\u4e0b\u8a18\u306e\u30b9\u30c6\u30c3\u30d7\u306b\u5f93\u3044\u307e\u3059:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Azure ML \u74b0\u5883\u3001\u597d\u307f\u306e\u30c7\u30a3\u30fc\u30d7\u30e9\u30fc\u30cb\u30f3\u30b0\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3001MPI \u3092\u4f7f\u3044\u307e\u3059\u3002AzureML \u306f\u4eba\u6c17\u306e\u3042\u308b\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u74b0\u5883\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002",(0,i.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/machine-learning/resource-curated-environments"},"\u30ad\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3055\u308c\u305f\u74b0\u5883")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"MpiConfiguration"),"\u3092\u5b9a\u7fa9\u3057\u3066\u671b\u307e\u3057\u3044",(0,i.kt)("inlineCode",{parentName:"li"},"process_count_per_node"),"\u3068",(0,i.kt)("inlineCode",{parentName:"li"},"node_count"),"\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002per-process-launch \u306e\u5834\u5408\u306f",(0,i.kt)("inlineCode",{parentName:"li"},"process_count_per_node"),"\u306f\u30ce\u30fc\u30c9\u3042\u305f\u308a\u306eGPU\u6570\u3068\u540c\u3058\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3082\u3057\u3082\u30e6\u30fc\u30b6\u30fc\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u30ce\u30fc\u30c9\u3042\u305f\u308a\u306e\u5b9f\u884c\u30d7\u30ed\u30bb\u30b9\u6570\u306b\u8cac\u4efb\u3092\u6301\u3064\u5834\u5408\u3001per-node-launch \u306f 1 (\u30c7\u30d5\u30a9\u30eb\u30c8\u5024)\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"MpiConfiguration"),"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092",(0,i.kt)("inlineCode",{parentName:"li"},"ScriptRunConfig"),"\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3067\u3042\u308b",(0,i.kt)("inlineCode",{parentName:"li"},"distributed_job_config"),"\u306b\u6e21\u3057\u307e\u3059\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import Workspace, ScriptRunConfig, Environment, Experiment\nfrom azureml.core.runconfig import MpiConfiguration\n\ncurated_env_name = 'AzureML-PyTorch-1.6-GPU'\npytorch_env = Environment.get(workspace=ws, name=curated_env_name)\ndistr_config = MpiConfiguration(process_count_per_node=4, node_count=2)\n\nrun_config = ScriptRunConfig(\n  source_directory= './src',\n  script='train.py',\n  compute_target=compute_target,\n  environment=pytorch_env,\n  distributed_job_config=distr_config,\n)\n\n# \u30b8\u30e7\u30d6\u3092\u958b\u59cb\u3059\u308b\u305f\u3081\u306b\u69cb\u6210\u60c5\u5831\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3059\u308b\nrun = Experiment(ws, \"experiment_name\").submit(run_config)\n")),(0,i.kt)("h3",{id:"horovod"},"Horovod"),(0,i.kt)("p",null,"\u3082\u3057\u3082\u30e6\u30fc\u30b6\u30fc\u304c\u9078\u629e\u3057\u305f\u30c7\u30a3\u30fc\u30d7\u30e9\u30fc\u30cb\u30f3\u30b0\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3068\u5171\u306b ",(0,i.kt)("a",{parentName:"p",href:"https://horovod.readthedocs.io/en/stable/index.html"},"Horovod")," \u3092\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306b\u4f7f\u3046\u5834\u5408\u3001MPI \u30b8\u30e7\u30d6\u69cb\u6210\u3092\u4f7f\u3046\u3053\u3068\u3067 Azure ML \u4e0a\u3067\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u4e0b\u8a18\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b3\u30fc\u30c9\u304c\u6b63\u3057\u304f Horovod \u3067\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3059\u308b Azure ML \u74b0\u5883\u306b Horovod \u3068 MPI \u3092\u542b\u3093\u3067\u3044\u308b\u3053\u3068\u3002PyTorch \u3068 TensorFlow \u306e\u30ad\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u3055\u308c\u305f GPU \u74b0\u5883\u306b\u306f Horovod \u3068\u305d\u306e\u8a2d\u5b9a\u60c5\u5831\u304c\u4ed8\u5c5e\u3057\u3066\u3044\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u4efb\u610f\u306e\u5206\u6563\u3092\u6307\u5b9a\u3057\u305f",(0,i.kt)("inlineCode",{parentName:"li"},"MpiConfiguration"),"\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3002")),(0,i.kt)("h4",{id:"\u4f8b"},"\u4f8b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Azure/azureml-examples/tree/main/python-sdk/workflows/train/tensorflow/mnist-distributed-horovod"},"azureml-examples: TensorFlow distributed training using Horovod"))),(0,i.kt)("h3",{id:"deepspeed"},"DeepSpeed"),(0,i.kt)("p",null,"Azure ML \u4e0a\u3067 ",(0,i.kt)("a",{parentName:"p",href:"https://www.deepspeed.ai/"},"DeepSpeed")," \u3092\u4f7f\u3063\u3066\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u884c\u3046\u306b\u306f\u3001DeepSpeed \u306e\u30ab\u30b9\u30bf\u30e0\u30e9\u30f3\u30c1\u30e3\u30fc\u3092\u4f7f\u308f\u306a\u3044\u3067\u304f\u3060\u3055\u3044\u3002\u4ee3\u308f\u308a\u306b\u3001",(0,i.kt)("a",{parentName:"p",href:"https://www.deepspeed.ai/getting-started/#mpi-and-azureml-compatibility"},"MPI")," \u3092\u4f7f\u3063\u3066\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b8\u30e7\u30d6\u3092\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),(0,i.kt)("p",null,"\u4e0b\u8a18\u304c\u884c\u308f\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u30b8\u30e7\u30d6\u3092\u5b9f\u884c\u3059\u308b Azure ML \u74b0\u5883\u304c DeepSpeed \u3068\u305d\u306e\u4f9d\u5b58\u95a2\u4fc2\u3001Open MPI\u3001mpi4py \u3092\u542b\u3093\u3067\u3044\u308b\u3053\u3068\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u4efb\u610f\u306e\u5206\u6563\u3092\u6307\u5b9a\u3057\u305f",(0,i.kt)("inlineCode",{parentName:"li"},"MpiConfiguration"),"\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3002")),(0,i.kt)("h4",{id:"\u4f8b-1"},"\u4f8b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Azure/azureml-examples/tree/main/python-sdk/workflows/train/deepspeed/cifar"},"azureml-examples: Distributed training with DeepSpeed on CIFAR-10"))),(0,i.kt)("h3",{id:"open-mpi-\u306e\u74b0\u5883\u5909\u6570"},"Open MPI \u306e\u74b0\u5883\u5909\u6570"),(0,i.kt)("p",null,"MPI \u30b8\u30e7\u30d6\u3092 Open MPI \u30a4\u30e1\u30fc\u30b8\u3067\u5b9f\u884c\u3059\u308b\u6642\u3001\u5b9f\u884c\u3055\u308c\u305f\u305d\u308c\u305e\u308c\u306e\u30d7\u30ed\u30bb\u30b9\u306b\u5bfe\u3057\u3066\u4e0b\u8a18\u306e\u74b0\u5883\u5909\u6570\u304c\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"OMPI_COMM_WORLD_RANK - \u30d7\u30ed\u30bb\u30b9\u306e\u30e9\u30f3\u30af"),(0,i.kt)("li",{parentName:"ol"},"OMPI_COMM_WORLD_SIZE - \u30ef\u30fc\u30eb\u30c9\u306e\u30b5\u30a4\u30ba (\u30d7\u30ed\u30bb\u30b9\u304c\u542b\u307e\u308c\u308bMPI_COMM_WORLD\u5185\u306b\u5b58\u5728\u3059\u308b\u30d7\u30ed\u30bb\u30b9\u6570)"),(0,i.kt)("li",{parentName:"ol"},"AZ_BATCH_MASTER_NODE - \u30de\u30b9\u30bf\u30fc\u30a2\u30c9\u30ec\u30b9\u3068\u30dd\u30fc\u30c8\u3001MASTER_ADDR:MASTER_PORT"),(0,i.kt)("li",{parentName:"ol"},"OMPI_COMM_WORLD_LOCAL_RANK - \u30ce\u30fc\u30c9\u4e0a\u3067\u306e\u30d7\u30ed\u30bb\u30b9\u306e\u30ed\u30fc\u30ab\u30eb\u30e9\u30f3\u30af"),(0,i.kt)("li",{parentName:"ol"},"OMPI_COMM_WORLD_LOCAL_SIZE - \u30ce\u30fc\u30c9\u4e0a\u306e\u30d7\u30ed\u30bb\u30b9\u6570")),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u540d\u524d\u306b\u3082\u304b\u304b\u308f\u3089\u305a\u3001OMPI_COMM_WORLD_NODE_RANK \u306f NODE_RANK \u3068\u5bfe\u5fdc\u3057\u3066\u3044\u307e\u305b\u3093\u3002per-node-launcher \u3092\u4f7f\u3046\u306b\u306f\u3001\u5358\u306b",(0,i.kt)("inlineCode",{parentName:"p"},"process_count_per_node=1"),"\u3092\u8a2d\u5b9a\u3057\u3066\u3001OMPI_COMM_WORLD_RANK \u3092 NODE_RANK\u3068\u3057\u3066\u4f7f\u3044\u307e\u3059\u3002"))),(0,i.kt)("h2",{id:"pytorch"},"PyTorch"),(0,i.kt)("p",null,"Azure ML \u306f PyTorch \u306e\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u6a5f\u80fd (",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed"),") \u3092\u4f7f\u3063\u305f\u5206\u6563\u30b8\u30e7\u30d6\u5b9f\u884c\u3082\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\u3002"),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"torch.nn.parallel.DistributedDataParallel \u5bfe torch.nn.DataParallel / torch.multiprocessing \u306e\u6bd4\u8f03")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u3001\u30de\u30eb\u30c1\u30ce\u30fc\u30c9\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3069\u3061\u3089\u306e\u5834\u5408\u3082\u3001\u4e26\u5217\u51e6\u7406\u306b\u3064\u3044\u3066\u306f ",(0,i.kt)("a",{parentName:"p",href:"https://pytorch.org/tutorials/intermediate/ddp_tutorial.html#comparison-between-dataparallel-and-distributeddataparallel"},"PyTorch \u306e\u516c\u5f0f\u30ac\u30a4\u30c9"),"\u3067\u306f DistributedDataParallel (DDP) \u3092 DataParallel \u3088\u308a\u3082\u512a\u5148\u3057\u3066\u4f7f\u3063\u3066\u3044\u307e\u3059\u3002\u3055\u3089\u306b\u3001PyTorch \u306f ",(0,i.kt)("a",{parentName:"p",href:"https://pytorch.org/docs/stable/notes/cuda.html#use-nn-parallel-distributeddataparallel-instead-of-multiprocessing-or-nn-dataparallel"},"multiprocessing \u30d1\u30c3\u30b1\u30fc\u30b8\u3088\u308a\u3082 DistributedDataParallel \u3092\u63a8\u5968\u3057\u3066\u3044\u307e\u3059"),"\u3002\u3088\u3063\u3066\u3001Azure ML \u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3068\u30b5\u30f3\u30d7\u30eb\u3082 DistributedDataParallel \u306b\u6ce8\u76ee\u3057\u307e\u3059\u3002"))),(0,i.kt)("h3",{id:"\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u521d\u671f\u5316"},"\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u521d\u671f\u5316"),(0,i.kt)("p",null,"\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30d0\u30c3\u30af\u30dc\u30fc\u30f3\u306f\u3001\u4e92\u3044\u306e\u5b58\u5728\u3092\u77e5\u3063\u3066\u3044\u3066\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u53d6\u308a\u5408\u3046\u30d7\u30ed\u30bb\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u306b\u3088\u3063\u3066\u6210\u308a\u7acb\u3063\u3066\u3044\u307e\u3059\u3002PyTorch \u306e\u5834\u5408\u3001\u305d\u306e\u30d7\u30ed\u30bb\u30b9\u306e\u30b0\u30eb\u30fc\u30d7\u306f ",(0,i.kt)("strong",{parentName:"p"},"\u3059\u3079\u3066\u306e\u5206\u6563\u30d7\u30ed\u30bb\u30b9")," \u306e\u4e2d\u3067 ",(0,i.kt)("a",{parentName:"p",href:"https://pytorch.org/docs/stable/distributed.html#torch.distributed.init_process_group"},"torch.distributed.init_process_group")," \u3092\u547c\u3076\u3053\u3068\u3067\u4f5c\u6210\u3055\u308c\u307e\u3059\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"torch.distributed.init_process_group(backend='nccl', init_method='env://', ...)\n")),(0,i.kt)("p",null,"\u6700\u3082\u4e00\u822c\u7684\u306b\u4f7f\u308f\u308c\u308b\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u306f ",(0,i.kt)("strong",{parentName:"p"},"mpi"),"\u3001",(0,i.kt)("strong",{parentName:"p"},"nccl"),"\u3001",(0,i.kt)("strong",{parentName:"p"},"gloo")," \u3067\u3059\u3002GPU \u30d9\u30fc\u30b9\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3067\u306f\u3001\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u306e\u89b3\u70b9\u304b\u3089 ",(0,i.kt)("strong",{parentName:"p"},"nccl")," \u304c\u5f37\u304f\u63a8\u5968\u3055\u308c\u3066\u304a\u308a\u3001\u53ef\u80fd\u306a\u5834\u5408\u306f\u3053\u308c\u3092\u4f7f\u7528\u3059\u3079\u304d\u3067\u3059\u3002"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"init_method"),"\u306f\u3001\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3092\u4f7f\u3063\u3066\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u3092\u78ba\u8a8d\u3059\u308b\u3060\u3051\u3067\u306f\u306a\u304f\u3001\u5404\u30d7\u30ed\u30bb\u30b9\u304c\u4e92\u3044\u3092\u898b\u3064\u3051\u308b\u65b9\u6cd5\u3092\u6307\u5b9a\u3057\u305f\u308a\u3001\u521d\u671f\u5316\u3092\u884c\u3044\u307e\u3059\u3002\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u306f\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"init_method"),"\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u5834\u5408\u3001PyTorch\u306f\u74b0\u5883\u5909\u6570\u306e\u521d\u671f\u5316\u30e1\u30bd\u30c3\u30c9 (",(0,i.kt)("inlineCode",{parentName:"p"},"env://"),") \u3092\u4f7f\u3044\u307e\u3059\u3002Azure ML \u4e0a\u3067\u5206\u6563 PyTorch \u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b3\u30fc\u30c9\u3067\u3082\u3001\u3053\u306e\u521d\u671f\u5316\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\u3053\u3068\u304c\u63a8\u5968\u3055\u308c\u3066\u3044\u307e\u3059\u3002\u74b0\u5883\u5909\u6570\u306e\u521d\u671f\u5316\u306e\u305f\u3081\u306b PyTorch \u306f\u4e0b\u8a18\u306e\u74b0\u5883\u5909\u6570\u3092\u63a2\u3057\u307e\u3059:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"MASTER_ADDR")," - \u30e9\u30f3\u30af 0 \u306e\u30d7\u30ed\u30bb\u30b9\u3092\u30db\u30b9\u30c8\u3059\u308b\u30de\u30b7\u30f3\u306e IP \u30a2\u30c9\u30ec\u30b9\u3002"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"MASTER_PORT")," - \u30e9\u30f3\u30af 0 \u306e\u30d7\u30ed\u30bb\u30b9\u3092\u30db\u30b9\u30c8\u3059\u308b\u30de\u30b7\u30f3\u306e\u30d5\u30ea\u30fc\u30dd\u30fc\u30c8\u3002"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"WORLD_SIZE")," - \u30d7\u30ed\u30bb\u30b9\u306e\u5408\u8a08\u6570\u3002\u3053\u306e\u6570\u306f\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3067\u4f7f\u7528\u3055\u308c\u308b\u30c7\u30d0\u30a4\u30b9 (GPU) \u306e\u6570\u3068\u540c\u3058\u306b\u3059\u3079\u304d\u3067\u3059\u3002"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"RANK")," - \u73fe\u5728\u306e\u30d7\u30ed\u30bb\u30b9\u306e\u30b0\u30ed\u30fc\u30d0\u30eb\u30e9\u30f3\u30af\u3002\u8003\u3048\u3089\u308c\u308b\u5024\u306f 0 \u304b\u3089\u30ef\u30fc\u30eb\u30c9\u30b5\u30a4\u30ba -1 \u307e\u3067\u3067\u3059\u3002")),(0,i.kt)("p",null,"\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u306e\u521d\u671f\u5316\u306b\u95a2\u3059\u308b\u3088\u308a\u8a73\u7d30\u306a\u60c5\u5831\u306f\u6b21\u306e\u30ea\u30f3\u30af\u5148\u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002 ",(0,i.kt)("a",{parentName:"p",href:"https://pytorch.org/docs/stable/distributed.html#torch.distributed.init_process_group"},"PyTorch documentation")),(0,i.kt)("p",null,"\u3053\u308c\u3088\u308a\u5148\u306b\u8a18\u8f09\u3059\u308b\u591a\u304f\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u540c\u3058\u304f\u4e0b\u8a18\u306e\u74b0\u5883\u5909\u6570\u3092\u5fc5\u8981\u3068\u3057\u307e\u3059:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"LOCAL_RANK")," - \u30ce\u30fc\u30c9\u4e0a\u306e\u30d7\u30ed\u30bb\u30b9\u306e\u30ed\u30fc\u30ab\u30eb (\u76f8\u5bfe) \u30e9\u30f3\u30af\u3002\u8003\u3048\u3089\u308c\u308b\u5024\u306f 0 \u304b\u3089\u30ce\u30fc\u30c9\u4e0a\u306e\u30d7\u30ed\u30bb\u30b9\u6570 -1 \u307e\u3067\u3067\u3059\u3002\u30c7\u30fc\u30bf\u6e96\u5099\u306e\u3088\u3046\u306a\u69d8\u3005\u306a\u30aa\u30da\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u30ce\u30fc\u30c9\u3054\u3068\u306b 1 \u56de\u305a\u3064\u5b9f\u884c\u3055\u308c\u308b\u305f\u3081\u3001\u3053\u306e\u60c5\u5831\u306f\u6709\u7528\u3067\u3059\u3002 --- \u901a\u5e38 local_rank = 0 \u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"NODE_RANK")," - \u30de\u30eb\u30c1\u30ce\u30fc\u30c9\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3067\u4f7f\u308f\u308c\u308b\u30ce\u30fc\u30c9\u306e\u30e9\u30f3\u30af\u3067\u3059\u3002\u8003\u3048\u3089\u308c\u308b\u5024\u306f 0 \u304b\u3089\u30ce\u30fc\u30c9\u6570\u306e\u5408\u8a08 -1 \u307e\u3067\u3067\u3059\u3002")),(0,i.kt)("h3",{id:"\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3"},"\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3"),(0,i.kt)("p",null,"Azure ML \u306e PyTorch \u30b8\u30e7\u30d6\u306f\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b 2 \u7a2e\u985e\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\u3002"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Per-process-launcher"),": \u30b7\u30b9\u30c6\u30e0\u306f\u30e6\u30fc\u30b6\u30fc\u306e\u305f\u3081\u306b\u3001\u30d7\u30ed\u30bb\u30b9\u30b0\u30eb\u30fc\u30d7\u3092\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\u3059\u308b\u95a2\u9023\u60c5\u5831 (e.g. \u74b0\u5883\u5909\u6570) \u3068\u5171\u306b\u3001\u3059\u3079\u3066\u306e\u5206\u6563\u30d7\u30ed\u30bb\u30b9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Per-node-launcher"),": \u30e6\u30fc\u30b6\u30fc\u306f Azure ML \u306b\u5bfe\u3057\u3066\u3001\u5404\u30ce\u30fc\u30c9\u3067\u306e\u5b9f\u884c\u3092\u53d7\u3051\u53d6\u308b\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u30e9\u30f3\u30c1\u30e3\u30fc\u3092\u4e0e\u3048\u307e\u3059\u3002\u3053\u306e\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u30e9\u30f3\u30c1\u30e3\u30fc\u306f\u4e0e\u3048\u3089\u308c\u305f\u30ce\u30fc\u30c9\u4e0a\u3067\u306e\u5404\u30d7\u30ed\u30bb\u30b9\u306e\u5b9f\u884c\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002\u5404\u30ed\u30fc\u30ab\u30eb\u30ce\u30fc\u30c9\u3067\u306f\u3001\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u30e9\u30f3\u30c1\u30e3\u30fc\u306b\u3088\u3063\u3066 RANK \u3068 LOCAL_RANK \u304c\u8a2d\u5b9a\u3055\u308c\u307e\u3059\u3002",(0,i.kt)("strong",{parentName:"li"},"torch.distributed.launch")," \u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u3068 PyTorch Lightning \u306e\u4e21\u65b9\u304c\u3053\u3061\u3089\u306b\u8a72\u5f53\u3057\u307e\u3059\u3002")),(0,i.kt)("p",null,"\u3053\u308c\u3089\u306e\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u9593\u306b\u6839\u672c\u7684\u306a\u5dee\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u307b\u3068\u3093\u3069\u30e6\u30fc\u30b6\u30fc\u306e\u597d\u307f\u3001\u3082\u3057\u304f\u306f Lightning \u3084 Hugging Face \u306a\u3069\u306e\u3088\u304f\u898b\u308b PyTorch \u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u30fb\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u3057\u304d\u305f\u308a\u306b\u3088\u308b\u3082\u306e\u3067\u3059\u3002"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u306e\u30b7\u30ca\u30ea\u30aa\u306f\u3001\u305d\u308c\u305e\u308c\u306e\u5b9f\u884c\u30aa\u30d7\u30b7\u30e7\u30f3\u306b\u304a\u3051\u308b Azure ML PyTorch \u30b8\u30e7\u30d6\u306e\u69cb\u6210\u65b9\u6cd5\u306e\u3088\u308a\u8a73\u7d30\u306a\u60c5\u5831\u306b\u8e0f\u307f\u8fbc\u307f\u307e\u3059\u3002"),(0,i.kt)("h3",{id:"distributeddataparallel-per-process-launch"},"DistributedDataParallel (per-process-launch)"),(0,i.kt)("p",null,"Azure ML \u306f",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u306e\u3088\u3046\u306a\u30e9\u30f3\u30c1\u30e3\u30fc\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u3092\u4f7f\u3046\u3053\u3068\u306a\u304f\u30d7\u30ed\u30bb\u30b9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u3066\u3044\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u5206\u6563 PyTorch \u30b8\u30e7\u30d6\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u306f\u3001\u4e0b\u8a18\u306e\u3053\u3068\u3092\u3059\u308b\u3060\u3051\u3067\u3059:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u3068\u5f15\u6570\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"PyTorchConfiguration"),"\u3092\u4f5c\u6210\u3057\u3001",(0,i.kt)("inlineCode",{parentName:"li"},"node_count"),"\u3068",(0,i.kt)("inlineCode",{parentName:"li"},"process_count"),"\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002",(0,i.kt)("inlineCode",{parentName:"li"},"process_count"),"\u306f\u5b9f\u884c\u3057\u305f\u3044\u30b8\u30e7\u30d6\u306b\u304a\u3051\u308b\u5408\u8a08\u30d7\u30ed\u30bb\u30b9\u6570\u3068\u4e00\u81f4\u3057\u307e\u3059\u3002\u3053\u306e\u5024\u306f\u4e00\u822c\u7684\u306b",(0,i.kt)("inlineCode",{parentName:"li"},"\u30ce\u30fc\u30c9\u3042\u305f\u308a\u306e GPU \u6570 x \u30ce\u30fc\u30c9\u6570"),"\u3068\u540c\u3058\u3067\u3059\u3002",(0,i.kt)("inlineCode",{parentName:"li"},"process_count"),"\u304c\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u3001Azure ML \u306f\u30c7\u30d5\u30a9\u30eb\u30c8\u3067\u5404\u30ce\u30fc\u30c9\u306b\u3064\u304d 1 \u30d7\u30ed\u30bb\u30b9\u305a\u3064\u5b9f\u884c\u3057\u307e\u3059\u3002")),(0,i.kt)("p",null,"Azure ML \u306f\u30d7\u30ed\u30bb\u30b9\u30ec\u30d9\u30eb\u3067 RANK \u3068 LOCAL_RANK \u306e\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u305f\u4e0a\u3067\u3001\u5404\u30ce\u30fc\u30c9\u3067 MASTER_ADDR\u3001MASTER_PORT\u3001WORLD_SIZE\u3001NODE_RANK \u306e\u74b0\u5883\u5909\u6570\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002"),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u5404\u30ce\u30fc\u30c9\u4e0a\u3067\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u3053\u306e\u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3059\u308b\u305f\u3081\u306b\u306f\u3001Azure ML Python SDK ",(0,i.kt)("inlineCode",{parentName:"p"},">= 1.22.0"),"\u3092\u4f7f\u7528\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3053\u308c\u306f\u3001process_count \u304c\u30d0\u30fc\u30b8\u30e7\u30f3 1.22.0 \u3067\u5c0e\u5165\u3055\u308c\u305f\u305f\u3081\u3067\u3059\u3002"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import ScriptRunConfig, Environment, Experiment\nfrom azureml.core.runconfig import PyTorchConfiguration\n\ncurated_env_name = 'AzureML-PyTorch-1.6-GPU'\npytorch_env = Environment.get(workspace=ws, name=curated_env_name)\ndistr_config = PyTorchConfiguration(process_count=8, node_count=2)\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  script='train.py',\n  arguments=['--epochs', 50],\n  compute_target=compute_target,\n  environment=pytorch_env,\n  distributed_job_config=distr_config,\n)\n\nrun = Experiment(ws, 'experiment_name').submit(run_config)\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u3082\u3057\u3082\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u30ed\u30fc\u30ab\u30eb\u30e9\u30f3\u30af\u30e9\u30f3\u30af\u3084\u30e9\u30f3\u30af\u3092\u30b9\u30af\u30ea\u30d7\u30c8\u5f15\u6570\u3068\u3057\u3066\u53d7\u3051\u53d6\u308b\u5834\u5408\u3001\u5f15\u6570\u306e\u4e2d\u3067\u3053\u306e\u3088\u3046\u306b\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059: ",(0,i.kt)("inlineCode",{parentName:"p"},"arguments=['--epochs', 50, '--local_rank', $LOCAL_RANK]")))),(0,i.kt)("h4",{id:"\u4f8b-2"},"\u4f8b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Azure/azureml-examples/tree/main/python-sdk/workflows/train/pytorch/cifar-distributed"},"azureml-examples: Distributed training with PyTorch on CIFAR-10"))),(0,i.kt)("h3",{id:"torchdistributedlaunch-per-node-launch-\u306e\u4f7f\u7528"},(0,i.kt)("inlineCode",{parentName:"h3"},"torch.distributed.launch")," (per-node-launch) \u306e\u4f7f\u7528"),(0,i.kt)("p",null,"PyTorch \u306f\u5404\u30ce\u30fc\u30c9\u4e0a\u3067\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306e\u3059\u308b\u305f\u3081\u306e\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u3068\u3057\u3066 ",(0,i.kt)("a",{parentName:"p",href:"https://pytorch.org/docs/stable/distributed.html#launch-utility"},"torch.distributed.launch")," \u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002\u3053\u306e",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u30e2\u30b8\u30e5\u30fc\u30eb\u306f\u5404\u30ce\u30fc\u30c9\u4e0a\u3067\u8907\u6570\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30d7\u30ed\u30bb\u30b9\u3092\u751f\u6210\u3057\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u4ee5\u4e0b\u306e\u30b9\u30c6\u30c3\u30d7\u306f\u3069\u306e\u3088\u3046\u306b Azure ML \u4e0a\u3067 per-node-launcher \u306b\u3088\u308a PyTorch \u30b8\u30e7\u30d6\u3092\u69cb\u6210\u3059\u308b\u304b\u3068\u3044\u3046\u30c7\u30e2\u30f3\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002\u3053\u308c\u306f\u4ee5\u4e0b\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3068\u540c\u7b49\u306e\u3053\u3068\u3067\u3059\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"python -m torch.distributed.launch --nproc_per_node <num processes per node> \\\n  --nnodes <num nodes> --node_rank $NODE_RANK --master_addr $MASTER_ADDR \\\n  --master_port $MASTER_PORT --use_env \\\n  <your training script> <your script arguments>\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"torch.distributed.launch"),"\u30b3\u30de\u30f3\u30c9\u3092",(0,i.kt)("inlineCode",{parentName:"li"},"ScriptRunConfig"),"\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e",(0,i.kt)("inlineCode",{parentName:"li"},"command")," \u30d1\u30e9\u30e1\u30fc\u30bf\u306b\u4e0e\u3048\u307e\u3059\u3002Azure ML \u306f\u30e6\u30fc\u30b6\u30fc\u304c\u6307\u5b9a\u3057\u305f\u30af\u30e9\u30b9\u30bf\u30fc\u4e0a\u306e\u5404\u30ce\u30fc\u30c9\u4e0a\u3067\u3053\u306e\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u307e\u3059\u3002",(0,i.kt)("inlineCode",{parentName:"li"},"--nproc_per_node"),"\u306f\u5404\u30ce\u30fc\u30c9\u3067\u5229\u7528\u53ef\u80fd\u306a GPU \u6570\u3068\u540c\u3058\u304b\u305d\u308c\u4ee5\u4e0b\u306b\u8a2d\u5b9a\u3057\u307e\u3059\u3002MASTER_ADDR\u3001MASTER_POR\u3001NODE_RANK \u306e\u3059\u3079\u3066\u306f Azure ML \u306b\u3088\u3063\u3066\u8a2d\u5b9a\u3055\u308c\u308b\u305f\u3081\u3001\u30e6\u30fc\u30b6\u30fc\u306f\u30b3\u30de\u30f3\u30c9\u4e2d\u3067\u3053\u308c\u3089\u306e\u74b0\u5883\u5909\u6570\u3092\u53c2\u7167\u3059\u308b\u3060\u3051\u3067\u6e08\u307f\u307e\u3059\u3002Azure ML \u306f MASTER_PORT \u3092",(0,i.kt)("inlineCode",{parentName:"li"},"6105")," \u306b\u8a2d\u5b9a\u3057\u307e\u3059\u304c\u3001\u30e6\u30fc\u30b6\u30fc\u306f\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u7570\u306a\u308b\u5024\u3092 torch.distributed.launch \u30b3\u30de\u30f3\u30c9\u306e",(0,i.kt)("inlineCode",{parentName:"li"},"--master_port"),"\u5f15\u6570\u306b\u6e21\u3059\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002(\u305d\u306e\u6642\u3001\u5b9f\u884c\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u306f\u74b0\u5883\u5909\u6570\u3092\u518d\u8a2d\u5b9a\u3057\u307e\u3059\u3002)"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"PyTorchConfiguration"),"\u3092\u4f5c\u6210\u3057\u3001",(0,i.kt)("inlineCode",{parentName:"li"},"node_count"),"\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import ScriptRunConfig, Environment, Experiment\nfrom azureml.core.runconfig import PyTorchConfiguration\n\ncurated_env_name = 'AzureML-PyTorch-1.6-GPU'\npytorch_env = Environment.get(workspace=ws, name=curated_env_name)\ndistr_config = PyTorchConfiguration(node_count=2)\nlaunch_cmd = \"python -m torch.distributed.launch --nproc_per_node 4 --nnodes 2 --node_rank $NODE_RANK --master_addr $MASTER_ADDR --master_port $MASTER_PORT --use_env train.py --epochs 50\".split()\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  command=launch_cmd,\n  compute_target=compute_target,\n  environment=pytorch_env,\n  distributed_job_config=distr_config,\n)\n\nrun = Experiment(ws, 'experiment_name').submit(run_config)\n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),": \u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u30de\u30eb\u30c1 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"\u3082\u3057\u3082\u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u30de\u30eb\u30c1 GPU \u306e PyTorch \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u3053\u306e\u5b9f\u884c\u30e6\u30fc\u30c6\u30a3\u30ea\u30c6\u30a3\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306f\u3001ScriptRunConfig \u306e",(0,i.kt)("inlineCode",{parentName:"p"},"distributed_job_config"),"\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u306f\u3042\u308a\u307e\u305b\u3093\u3002"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-python"},"launch_cmd = \"python -m torch.distributed.launch --nproc_per_node 4 --use_env train.py --epochs 50\".split()\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  command=launch_cmd,\n  compute_target=compute_target,\n  environment=pytorch_env,\n)\n")))),(0,i.kt)("h4",{id:"\u4f8b-3"},"\u4f8b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Azure/azureml-examples/tree/main/python-sdk/workflows/train/pytorch/cifar-distributed"},"azureml-examples: Distributed training with PyTorch on CIFAR-10"))),(0,i.kt)("h3",{id:"pytorch-lightning"},"PyTorch Lightning"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://pytorch-lightning.readthedocs.io/en/stable/"},"PyTorch Lightning")," \u306f\u8efd\u91cf\u306e\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u30e9\u30a4\u30d6\u30e9\u30ea\u3067\u3001PyTorch \u306e\u30cf\u30a4\u30ec\u30d9\u30eb\u306a\u30a4\u30f3\u30bf\u30fc\u30d5\u30a7\u30fc\u30b9\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002Lightning \u3092\u4f7f\u3046\u3053\u3068\u3067\u3001\u7d20\u306e PyTorch \u306b\u3088\u308a\u5fc5\u8981\u3068\u3055\u308c\u308b\u4f4e\u30ec\u30d9\u30eb\u306e\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u69cb\u6210\u306e\u5927\u90e8\u5206\u3092\u62bd\u8c61\u5316\u3057\u3066\u3001\u30b7\u30f3\u30b0\u30eb GPU\u3001\u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u30de\u30eb\u30c1 GPU\u3001\u30de\u30eb\u30c1\u30ce\u30fc\u30c9\u30de\u30eb\u30c1 GPU \u8a2d\u5b9a\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002\u3053\u306e\u88cf\u5074\u3067\u306f",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u306e\u3088\u3046\u306b\u30de\u30eb\u30c1\u30d7\u30ed\u30bb\u30b9\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0 (\u30b7\u30f3\u30b0\u30eb\u30ce\u30fc\u30c9\u30de\u30eb\u30c1 GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u542b\u3080) \u3067\u306f\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"distributed_job_config"),"\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306a\u304f Azure ML \u4e0a\u3067\u30b3\u30fc\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002Lightning \u3067\u30de\u30eb\u30c1\u30ce\u30fc\u30c9\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u884c\u3046\u5834\u5408\u306f\u3001\u30e6\u30fc\u30b6\u30fc\u304c\u6307\u5b9a\u3057\u305f\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30af\u30e9\u30b9\u30bf\u30fc\u4e0a\u306e\u5404\u30ce\u30fc\u30c9\u3067\u4e0b\u8a18\u306e\u74b0\u5883\u5909\u6570\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"MASTER_ADDR"),(0,i.kt)("li",{parentName:"ul"},"MASTER_PORT"),(0,i.kt)("li",{parentName:"ul"},"NODE_RANK")),(0,i.kt)("p",null,"\u30de\u30eb\u30c1\u30ce\u30fc\u30c9 Lightning \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092 Azure ML \u4e0a\u3067\u5b9f\u884c\u3059\u308b\u5834\u5408\u306f ",(0,i.kt)("a",{parentName:"p",href:"#using-distributedddataparallel-per-node-launch"},"per-node-launch guide")," \u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"PyTorchConfiguration"),"\u3092\u5b9a\u7fa9\u3057\u3066\u671b\u307e\u3057\u3044",(0,i.kt)("inlineCode",{parentName:"li"},"node_count"),"\u3092\u6307\u5b9a\u3057\u307e\u3059\u3002Lightning \u306f\u5185\u90e8\u7684\u306b\u5404\u30ce\u30fc\u30c9\u306e\u30ef\u30fc\u30ab\u30fc\u30d7\u30ed\u30bb\u30b9\u5b9f\u884c\u3092\u7ba1\u7406\u3059\u308b\u305f\u3081\u3001",(0,i.kt)("inlineCode",{parentName:"li"},"process_count"),"\u3092\u6307\u5b9a\u3057\u3066\u306f\u3044\u3051\u307e\u305b\u3093\u3002"),(0,i.kt)("li",{parentName:"ul"},"PyTorch \u30b8\u30e7\u30d6\u306e\u305f\u3081\u306b\u3001Azure ML \u306f Lightning \u304c\u5fc5\u8981\u3068\u3059\u308b MASTER_ADDR\u3001MASTER_PORT\u3001and NODE_RANK \u74b0\u5883\u5909\u6570\u306e\u5236\u5fa1\u3092\u884c\u3044\u307e\u3059\u3002"),(0,i.kt)("li",{parentName:"ul"},"Lightning \u306f",(0,i.kt)("inlineCode",{parentName:"li"},"--gpus"),"\u3084",(0,i.kt)("inlineCode",{parentName:"li"},"--num_nodes"),"\u306a\u3069\u306e\u30c8\u30ec\u30fc\u30ca\u30fc\u30d5\u30e9\u30b0\u304b\u3089\u30b3\u30f3\u30d4\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0\u306e\u30ef\u30fc\u30eb\u30c9\u30b5\u30a4\u30ba\u3092\u5236\u5fa1\u3057\u3001\u5185\u90e8\u7684\u306b\u30e9\u30f3\u30af\u3084\u30ed\u30fc\u30ab\u30eb\u30e9\u30f3\u30af\u3092\u7ba1\u7406\u3057\u307e\u3059\u3002")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import ScriptRunConfig, Experiment\nfrom azureml.core.runconfig import PyTorchConfiguration\n\nnnodes = 2\nargs = ['--max_epochs', 50, '--gpus', 2, '--accelerator', 'ddp', '--num_nodes', nnodes]\ndistr_config = PyTorchConfiguration(node_count=nnodes)\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  script='train.py',\n  arguments=args,\n  compute_target=compute_target,\n  environment=pytorch_env,\n  distributed_job_config=distr_config,\n)\n\nrun = Experiment(ws, 'experiment_name').submit(run_config)\n")),(0,i.kt)("h3",{id:"hugging-face-transformers"},"Hugging Face Transformers"),(0,i.kt)("p",null,"Hugging Face \u306f\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u3092\u4f7f\u3063\u3066\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b Transformers \u3092\u4f7f\u3046\u969b\u306e\u591a\u304f\u306e ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/huggingface/transformers/tree/master/examples"},"\u30b5\u30f3\u30d7\u30eb")," \u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002Hugging Face Transformers Trainer API \u3092\u4f7f\u3063\u3066\u3053\u308c\u3089\u306e\u30b5\u30f3\u30d7\u30eb\u3084\u4efb\u610f\u306e\u30ab\u30b9\u30bf\u30e0\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u306f\u3001",(0,i.kt)("a",{parentName:"p",href:"#torchdistributedlaunch-per-node-launch-%E3%81%AE%E4%BD%BF%E7%94%A8"},"torch.distributed.launch \u306e\u4f7f\u7528")," \u306e\u30bb\u30af\u30b7\u30e7\u30f3\u3092\u53c2\u8003\u306b\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),(0,i.kt)("p",null,"8 \u3064\u306e GPU \u3092\u642d\u8f09\u3057\u305f\u30ce\u30fc\u30c9\u4e0a\u3067",(0,i.kt)("inlineCode",{parentName:"p"},"run_glue.py"),"\u3068\u3044\u3046\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u3088\u308a\u30c6\u30ad\u30b9\u30c8\u5206\u985e MNLI \u30bf\u30b9\u30af\u3092\u89e3\u304f BERT \u306e\u5de8\u5927\u30e2\u30c7\u30eb\u306e\u30d5\u30a1\u30a4\u30f3\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u30b8\u30e7\u30d6\u3092\u69cb\u6210\u3059\u308b\u30b3\u30fc\u30c9\u306e\u4f8b:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import ScriptRunConfig\nfrom azureml.core.runconfig import PyTorchConfiguration\n\ndistr_config = PyTorchConfiguration() # \u30c7\u30d5\u30a9\u30eb\u30c8 node_count \u306f 1\nlaunch_cmd = \"python -m torch.distributed.launch --nproc_per_node 8 text-classification/run_glue.py --model_name_or_path bert-large-uncased-whole-word-masking --task_name mnli --do_train --do_eval --max_seq_length 128 --per_device_train_batch_size 8 --learning_rate 2e-5 --num_train_epochs 3.0 --output_dir /tmp/mnli_output\".split()\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  command=launch_cmd,\n  compute_target=compute_target,\n  environment=pytorch_env,\n  distributed_job_config=distr_config,\n)\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u3092\u4f7f\u308f\u305a\u306b\u3001",(0,i.kt)("a",{parentName:"p",href:"#distributeddataparallel-per-process-launch"},"per-process-launch")," \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3057\u3066\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u3082\u3067\u304d\u307e\u3059\u3002\u3053\u306e\u30e1\u30bd\u30c3\u30c9\u3092\u4f7f\u3046\u969b\u306b\u6c17\u3092\u3064\u3051\u308b\u3053\u3068\u306f\u3001Transformers ",(0,i.kt)("a",{parentName:"p",href:"https://huggingface.co/transformers/main_classes/trainer.html?highlight=launch#trainingarguments"},"TrainingArguments")," \u306f\u5f15\u6570\u4e2d\u306e\u30ed\u30fc\u30ab\u30eb\u30e9\u30f3\u30af (",(0,i.kt)("inlineCode",{parentName:"p"},"--local_rank"),") \u3092\u9664\u5916\u3059\u308b\u3053\u3068\u3067\u3059\u3002",(0,i.kt)("inlineCode",{parentName:"p"},"torch.distributed.launch"),"\u306f",(0,i.kt)("inlineCode",{parentName:"p"},"--use_env=False"),"\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3068\u304d\u3053\u308c\u3092\u7ba1\u7406\u3057\u307e\u3059\u304c\u3001Azure ML \u306f LOCAL_RANK \u74b0\u5883\u5909\u6570\u306e\u307f\u3092\u8a2d\u5b9a\u3059\u308b\u305f\u3081\u3001per-process-launch \u3092\u4f7f\u3046\u3068\u304d\u306f\u660e\u793a\u7684\u306b",(0,i.kt)("inlineCode",{parentName:"p"},"--local_rank=$LOCAL_RANK"),"\u5f15\u6570\u3092\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u306b\u6e21\u3059\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002"),(0,i.kt)("h2",{id:"tensorflow"},"TensorFlow"),(0,i.kt)("p",null,"\u3082\u3057\u3082\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b3\u30fc\u30c9\u3067 TensorFlow 2.x \u306e ",(0,i.kt)("inlineCode",{parentName:"p"},"tf.distribute.Strategy")," API \u306e\u3088\u3046\u306a ",(0,i.kt)("a",{parentName:"p",href:"https://www.tensorflow.org/guide/distributed_training"},"native distributed TensorFlow")," \u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f Azure ML \u306e",(0,i.kt)("inlineCode",{parentName:"p"},"TensorflowConfiguration"),"\u3092\u4ecb\u3057\u3066\u5206\u6563\u30b8\u30e7\u30d6\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u305d\u306e\u305f\u3081\u306b\u306f\u3001",(0,i.kt)("inlineCode",{parentName:"p"},"ScriptRunConfig"),"\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u306e",(0,i.kt)("inlineCode",{parentName:"p"},"distributed_job_config"),"\u30d1\u30e9\u30e1\u30fc\u30bf\u306b",(0,i.kt)("inlineCode",{parentName:"p"},"TensorflowConfiguration"),"\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002\u3082\u3057\u3082",(0,i.kt)("inlineCode",{parentName:"p"},"tf.distribute.experimental.MultiWorkerMirroredStrategy"),"\u3092\u4f7f\u3063\u3066\u3044\u308b\u5834\u5408\u306f\u3001\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b8\u30e7\u30d6\u3067\u4f7f\u7528\u3059\u308b\u30ce\u30fc\u30c9\u6570\u3092",(0,i.kt)("inlineCode",{parentName:"p"},"TensorflowConfiguration"),"\u306e",(0,i.kt)("inlineCode",{parentName:"p"},"worker_count"),"\u3067\u6307\u5b9a\u3057\u307e\u3059\u3002"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"from azureml.core import ScriptRunConfig, Environment, Experiment\nfrom azureml.core.runconfig import TensorflowConfiguration\n\ncurated_env_name = 'AzureML-TensorFlow-2.3-GPU'\ntf_env = Environment.get(workspace=ws, name=curated_env_name)\ndistr_config = TensorflowConfiguration(worker_count=2, parameter_server_count=0)\n\nrun_config = ScriptRunConfig(\n  source_directory='./src',\n  script='train.py',\n  compute_target=compute_target,\n  environment=tf_env,\n  distributed_job_config=distr_config,\n)\n\n# \u30b8\u30e7\u30d6\u3092\u958b\u59cb\u3059\u308b\u305f\u3081\u306b\u69cb\u6210\u60c5\u5831\u3092\u30b5\u30d6\u30df\u30c3\u30c8\u3057\u307e\u3059\u3002\nrun = Experiment(ws, \"experiment_name\").submit(run_config)\n")),(0,i.kt)("p",null,"\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u304c parameter server strategy \u3092\u4f7f\u7528\u3059\u308b\u5834\u5408 (i.e. \u30ec\u30ac\u30b7\u30fc\u306a TensorFlow 1.x \u3092\u4f7f\u3046\u5834\u5408) \u306f\u3001\u5408\u308f\u305b\u3066\u30b8\u30e7\u30d6\u306e\u4e2d\u3067\u4f7f\u7528\u3059\u308b parameter server \u306e\u6570\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002 (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"tf_config = TensorflowConfiguration(worker_count=2, parameter_server_count=1)"),")"),(0,i.kt)("h3",{id:"tf_config"},"TF_CONFIG"),(0,i.kt)("p",null,"TensofFlow \u3092\u4f7f\u3063\u3066\u8907\u6570\u306e\u30de\u30b7\u30f3\u4e0a\u3067\u306e\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u3092\u5b9f\u884c\u3059\u308b\u306b\u306f ",(0,i.kt)("strong",{parentName:"p"},"TF_CONFIG")," \u74b0\u5883\u5909\u6570\u304c\u5fc5\u8981\u306b\u306a\u308a\u307e\u3059\u3002TensorFlow \u30b8\u30e7\u30d6\u3092\u5b9f\u884c\u3059\u308b\u305f\u3081\u306b\u3001Azure ML \u306f\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u5b9f\u884c\u3059\u308b\u524d\u306b\u5404\u30ef\u30fc\u30ab\u30fc\u306b\u5bfe\u3057\u3066\u9069\u5207\u306a TF_CONFIG \u5909\u6570\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u3082\u3057\u5fc5\u8981\u306a\u5834\u5408\u306f\u3001\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30b9\u30af\u30ea\u30d7\u30c8\u304b\u3089",(0,i.kt)("inlineCode",{parentName:"p"},"os.environ['TF_CONFIG']"),"\u306b\u3088\u3063\u3066 TF_CONFIG \u306b\u30a2\u30af\u30bb\u30b9\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u3059\u3002"),(0,i.kt)("p",null,"\u30c1\u30fc\u30d5\u30ef\u30fc\u30ab\u30fc\u30ce\u30fc\u30c9\u3067 TF_CONFIG \u3092\u8a2d\u5b9a\u3059\u308b\u4f8b:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'TF_CONFIG=\'{\n    "cluster": {\n        "worker": ["host0:2222", "host1:2222"]\n    },\n    "task": {"type": "worker", "index": 0},\n    "environment": "cloud"\n}\'\n')),(0,i.kt)("h4",{id:"\u4f8b-4"},"\u4f8b"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/Azure/azureml-examples/tree/main/python-sdk/workflows/train/tensorflow/mnist-distributed"},"azureml-examples: Distributed TensorFlow training with MultiWorkerMirroredStrategy"))),(0,i.kt)("h2",{id:"infiniband-\u306b\u3088\u308b-gpu-\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30b7\u30e7\u30f3"},"InfiniBand \u306b\u3088\u308b GPU \u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u306e\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30b7\u30e7\u30f3"),(0,i.kt)("p",null,"Azure\u306b\u306f\u3001SR-IOV \u3068 InfiniBand \u3092\u30b5\u30dd\u30fc\u30c8\u3059\u308b RDMA \u5bfe\u5fdc\u306e VM \u30b7\u30ea\u30fc\u30ba\u304c\u3042\u308a\u307e\u3059 (NC\u3001ND\u3001H-\u30b7\u30ea\u30fc\u30ba)\u3002\u3053\u308c\u3089\u306e VM \u306f\u3001Ethernet \u30d9\u30fc\u30b9\u306e\u63a5\u7d9a\u6027\u3088\u308a\u3082\u306f\u308b\u304b\u306b\u9ad8\u6027\u80fd\u306e\u3001\u4f4e\u9045\u5ef6\u3067\u9ad8\u5e2f\u57df\u5e45\u306e InfiniBand \u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u3092\u4ecb\u3057\u3066\u30b3\u30df\u30e5\u30cb\u30b1\u30fc\u30b7\u30e7\u30f3\u3092\u884c\u3044\u307e\u3059\u3002SR-IOV for InfiniBand \u306f\u3001MPI \u30e9\u30a4\u30d6\u30e9\u30ea (MPI \u306f NVIDIA \u306e NCCL \u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u3092\u542b\u3080\u5206\u6563\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30d5\u30ec\u30fc\u30e0\u30ef\u30fc\u30af\u3084\u30c4\u30fc\u30eb\u306b\u3088\u3063\u3066\u5229\u7528\u3055\u308c\u307e\u3059) \u306b\u5bfe\u3057\u3066\u30cb\u30a2\u30d9\u30a2\u30e1\u30bf\u30eb\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002\u3053\u308c\u3089\u306e SKU \u306f \u9ad8\u8a08\u7b97\u8ca0\u8377\u30ef\u30fc\u30af\u30ed\u30fc\u30c9\u3084\u3001GPU \u306b\u3088\u308a\u30a2\u30af\u30bb\u30e9\u30ec\u30fc\u30c8\u3055\u308c\u308b\u6a5f\u68b0\u5b66\u7fd2\u30ef\u30fc\u30af\u30ed\u30fc\u30c9\u306e\u30cb\u30fc\u30ba\u3092\u6e80\u305f\u3059\u3053\u3068\u3092\u76ee\u7684\u3068\u3057\u3066\u3044\u307e\u3059\u3002\u3088\u308a\u8a73\u7d30\u306a\u60c5\u5831\u306f ",(0,i.kt)("a",{parentName:"p",href:"https://techcommunity.microsoft.com/t5/azure-ai/accelerating-distributed-training-in-azure-machine-learning/ba-p/1059050"},"Accelerating Distributed Training in Azure Machine Learning with SR-IOV")," \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),(0,i.kt)("p",null,"\u3082\u3057\u3082",(0,i.kt)("inlineCode",{parentName:"p"},"AmlCompute"),"\u30af\u30e9\u30b9\u30bf\u30fc\u3092",(0,i.kt)("inlineCode",{parentName:"p"},"Standard_ND40rs_v2"),"\u306a\u3069\u306e RDMA \u5bfe\u5fdc\u3067 InfiniBand \u304c\u6709\u52b9\u5316\u3055\u308c\u305f VM \u30b5\u30a4\u30ba\u3067\u4f5c\u6210\u3057\u3066\u3044\u308b\u5834\u5408\u306f\u3001OS \u30a4\u30e1\u30fc\u30b8\u306b\u306f InfiniBand \u3092\u6709\u52b9\u306b\u3059\u308b\u305f\u3081\u306b\u5fc5\u8981\u306a Mellanox OFED \u30c9\u30e9\u30a4\u30d0\u30fc \u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u69cb\u7bc9\u304c\u4e8b\u524d\u306b\u884c\u308f\u308c\u3066\u3044\u307e\u3059\u3002"))}s.isMDXComponent=!0}}]);