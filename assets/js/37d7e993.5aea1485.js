(self.webpackChunkaml_cheatsheet=self.webpackChunkaml_cheatsheet||[]).push([[374],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),m=l(n),d=o,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||r;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p.mdxType="string"==typeof e?e:o,i[1]=p;for(var l=2;l<r;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1115:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},metadata:function(){return p},toc:function(){return s},default:function(){return c}});var a=n(4034),o=n(9973),r=(n(7294),n(3905)),i={title:"Developing on Azure ML",description:"Guide to developing your code on Azure ML.",keywords:["ssh","development","compute"]},p={unversionedId:"cheatsheets/python/v1/ci-dev",id:"cheatsheets/python/v1/ci-dev",isDocsHomePage:!1,title:"Developing on Azure ML",description:"Guide to developing your code on Azure ML.",source:"@site/docs/cheatsheets/python/v1/ci-dev.md",sourceDirName:"cheatsheets/python/v1",slug:"/cheatsheets/python/v1/ci-dev",permalink:"/azureml-cheatsheets/docs/cheatsheets/python/v1/ci-dev",editUrl:"https://github.com/Azure/azureml-cheatsheets/tree/main/website/docs/cheatsheets/python/v1/ci-dev.md",version:"current",frontMatter:{title:"Developing on Azure ML",description:"Guide to developing your code on Azure ML.",keywords:["ssh","development","compute"]},sidebar:"pythonSidebar",previous:{title:"Debugging",permalink:"/azureml-cheatsheets/docs/cheatsheets/python/v1/debugging"}},s=[{value:"\ud83d\udea7 The hurdles",id:"-the-hurdles",children:[]},{value:"\ud83d\udd70\ufe0f Prepare compute for development",id:"\ufe0f-prepare-compute-for-development",children:[]},{value:"\ud83c\udfc3\u200d\u2640\ufe0f Commands",id:"\u2640\ufe0f-commands",children:[]},{value:"Advantages",id:"advantages",children:[]},{value:"Example",id:"example",children:[]}],l={toc:s};function c(e){var t=e.components,n=(0,o.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,a.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This guide gives some pointers for developing your code on Azure ML. A typical\nscenario might be testing your distributed training code, or some other aspect\nof your code that isn't well represented on your local devbox."),(0,r.kt)("p",null,"A common pain-point in these scenarios is that iteration on Azure ML can feel\nslow - especially when compared to developing on a VM."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Learning objective."),' To improve the development experience on Azure ML\nto match - or even exceed - that of a "bare" VM.'),(0,r.kt)("h2",{id:"-the-hurdles"},"\ud83d\udea7 The hurdles"),(0,r.kt)("p",null,"Two main reasons developing on Azure ML can feel slow as compared to a VM are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Any changes to my Python environment force Docker image rebuild which can\ntake >5 minutes.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Compute resources are ",(0,r.kt)("em",{parentName:"p"},"released")," between iterations, forcing me to wait for\nnew compute to warm up (e.g. pulling Docker images)."))),(0,r.kt)("p",null,"Below we provide some techniques to address these issues, as well as some advantages\nto working with Azure ML compute directly. We also provide a ",(0,r.kt)("a",{parentName:"p",href:"#example"},"example")," applying these\ntechniques."),(0,r.kt)("h2",{id:"\ufe0f-prepare-compute-for-development"},"\ud83d\udd70\ufe0f Prepare compute for development"),(0,r.kt)("p",null,"When creating your ",(0,r.kt)("em",{parentName:"p"},"compute instance / cluster")," there are a fews things you can\ndo to prepare for development:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Enable SSH on compute.")),(0,r.kt)("p",{parentName:"li"},"Supported on both ",(0,r.kt)("em",{parentName:"p"},"compute instance")," and ",(0,r.kt)("em",{parentName:"p"},"compute targets"),". This will allow you to\nuse your compute just like you would a VM."),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"VS Code Remote Extension.")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"VS Code's ",(0,r.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/docs/remote/ssh"},"remote extension"),"\nallows you to connect to your Azure ML compute resources via SSH.\nThis way you can develop directly in the cloud.")))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},'Increase "Idle seconds before scale down".')),(0,r.kt)("p",{parentName:"li"},"For compute targets you can increase this parameter e.g. to 30 minutes. This means\nthe cluster won't be released between runs while you iterate."),(0,r.kt)("div",{parentName:"li",className:"admonition admonition-warning alert alert--danger"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Don't forget to roll this back when you're done iterating."))))),(0,r.kt)("h2",{id:"\u2640\ufe0f-commands"},"\ud83c\udfc3\u200d\u2640\ufe0f Commands"),(0,r.kt)("p",null,"Typically you will submit your code to Azure ML via a ",(0,r.kt)("inlineCode",{parentName:"p"},"ScriptRunConfig")," a little like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"config = ScriptRunConfig(\n    source_directory='<path/to/source_directory>',\n    script='script.py',\n    compute_target=target,\n    environment=env,\n    ...\n)\n")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"For more details on using ",(0,r.kt)("inlineCode",{parentName:"p"},"ScriptRunConfig")," to submit your code see\n",(0,r.kt)("a",{parentName:"p",href:"script-run-config"},"Running Code in the cloud"),"."))),(0,r.kt)("p",null,"By using the ",(0,r.kt)("a",{parentName:"p",href:"script-run-config#commands"},(0,r.kt)("inlineCode",{parentName:"a"},"command"))," argument you can improve your agility.\nCommands allow you to chain together several steps in one e.g.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'command = "pip install torch && python script.py --learning_rate 2e-5".split()\n')),(0,r.kt)("p",null,"Another example would be to include a setup script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="setup.sh"',title:'"setup.sh"'},'echo "Running setup script"\npip install torch\npip install -r requirements.txt\nexport PYTHONPATH=$PWD\n')),(0,r.kt)("p",null,"and then calling it in your command"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'command = "bash setup.sh && python script.py --learning_rate 2e-5".split()\n')),(0,r.kt)("p",null,"This way Azure ML doesn't have to rebuild the docker image with incremental changes."),(0,r.kt)("h2",{id:"advantages"},"Advantages"),(0,r.kt)("p",null,"In addition to matching the development experience on a VM, there are certain benefits to\ndeveloping on Azure ML compute directly."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Production-ready.")," By developing directly in Azure ML you avoid the additional step of porting your\nVM-developed code to Azure ML later. This is particularly relevant if you intend to\nrun your production code on Azure ML."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Data access.")," If your training script makes use of data in Azure you can use the Azure ML\nPython SDK to read it (see ",(0,r.kt)("a",{parentName:"li",href:"data"},"Data")," for examples). The alternative is that you might have to\nfind some way of getting your data onto the VM you are developing on."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Notebooks.")," Azure ML's ",(0,r.kt)("em",{parentName:"li"},"compute insances")," come with Jupyter notebooks which can help with quick\ndebugging. Moreover, these notebooks can easily be run against different compute infrastructure\nand can be a great way to collaborate. ")),(0,r.kt)("h2",{id:"example"},"Example"),(0,r.kt)("p",null,"We provide a simple example demonstrating the mechanics of the above steps. Consider the following\nsetup:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"src/\n    .azureml/\n        config.json     # workspace connection config\n    train.py            # python script we are developing\n    setup.sh            # to run on compute before train.py\n    azureml_run.py      # submit job to azure\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="setup.sh"',title:'"setup.sh"'},'echo "Running setup script"\npip install numpy\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="train.py"',title:'"train.py"'},"import numpy as np\nprint(np.random.rand())\n")),(0,r.kt)("p",null,"Now from your local machine you can use the Azure ML Python SDK\nto execute your command in the cloud:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python",metastring:'title="azureml_run.py"',title:'"azureml_run.py"'},"from azureml.core import Workspace, Experiment, ScriptRunConfig\n\n# get workspace\nws = Workspace.from_config()\ntarget = ws.compute_targets['cpucluster']\nexp = Experiment(ws, 'dev-example')\n\ncommand = \"bash setup.sh && python script.py\".split()\n\n# set up script run configuration\nconfig = ScriptRunConfig(\n    source_directory='.',\n    command=command,\n    compute_target=target,\n)\n\n# submit script to AML\nrun = exp.submit(config)\nprint(run.get_portal_url()) # link to ml.azure.com\nrun.wait_for_completion(show_output=True)\n")),(0,r.kt)("p",null,"Now if you needed to update your Python environment for example you can simply\nadd commands to ",(0,r.kt)("inlineCode",{parentName:"p"},"setup.sh"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="setup.sh"',title:'"setup.sh"'},'echo "Running setup script"\npip install numpy\npip install pandas                  # add additional libraries\nexport CUDA_VISIBLE_DEVICES="0,1"   # set environment variables\nnvidia-smi                          # run helpful command-line tools\n')),(0,r.kt)("p",null,"without having to rebuild any Docker images."))}c.isMDXComponent=!0}}]);